<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Meneige Boekhouding</title>

<!-- Font Awesome & Google Fonts -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

<!-- Content Security Policy -->
<meta http-equiv="Content-Security-Policy" content="
  default-src 'self';
  font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com data:;
  style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com;
  script-src 'self' 'unsafe-inline' https://www.gstatic.com https://cdnjs.cloudflare.com;
  connect-src 'self' https://*.firebaseio.com https://*.googleapis.com;
">

<style>
body{
  margin:0;
  font-family:'Poppins',sans-serif;
  background:linear-gradient(135deg,#dbeafe,#f0f9ff);
  min-height:100vh;
  transition:.4s;
}
body.dark{background:linear-gradient(135deg,#020617,#020617);color:white;}

header{text-align:center;padding:20px;}
#saldoCard{
  background:white;margin:20px auto;max-width:360px;padding:20px;
  border-radius:20px;box-shadow:0 10px 25px rgba(0,0,0,.1);
  display:flex;flex-direction:column;align-items:center;
}
body.dark #saldoCard{background:#020617}

#saldo{font-size:32px;font-weight:600;margin-top:6px;}
#saldoCard i{font-size:24px;color:#60a5fa;}

.actions{display:flex;gap:12px;justify-content:center;margin:20px 0;}
.btn{
  padding:12px 18px;border-radius:14px;border:none;font-size:16px;cursor:pointer;
  display:flex;align-items:center;gap:8px;transition:.2s;
}
.btn:hover{opacity:.85;}
.add{background:#60a5fa;color:white;}
.cal{background:#fbbf24;color:white;}
.btn-view{background:#10b981;color:white;}
.btn.save{background:#3b82f6;color:white;}
.btn.cancel{background:#ef4444;color:white;}

#calendar{max-width:380px;margin:30px auto;display:grid;grid-template-columns:repeat(7,1fr);gap:6px;}
.day{
  background:white;padding:10px;border-radius:12px;text-align:center;
  cursor:pointer;box-shadow:0 4px 10px rgba(0,0,0,.08);transition:.2s;
}
.day:hover{transform:translateY(-2px);}
body.dark .day{background:#020617}
.day.has{border:2px solid #60a5fa}

#modal,#dayModal,#fixedCostsModal{
  position:fixed;inset:0;background:rgba(0,0,0,.5);
  display:none;align-items:center;justify-content:center;
}
.box{
  background:white;width:90%;max-width:360px;padding:20px;border-radius:20px;
  display:flex;flex-direction:column;gap:10px;
}
body.dark .box{background:#020617}

input,select{width:100%;padding:10px;margin-top:8px;border-radius:10px;border:1px solid #cbd5f5;}

.themeToggle{
  position:fixed;top:15px;right:15px;font-size:24px;cursor:pointer;
  background:rgba(255,255,255,0.9);padding:8px;border-radius:50%;
  transition:.3s;
}
.themeToggle:hover{background:rgba(255,255,255,1);}
body.dark .themeToggle{background:rgba(30,30,30,0.8);color:white;}

.entry{display:flex;justify-content:space-between;padding:6px 0;}
.pos{color:#22c55e;font-weight:500;}
.neg{color:#ef4444;font-weight:500;}
</style>
</head>

<body>

<div class="themeToggle" id="themeToggle">üåô</div>

<header>
  <h1>Meneige Boekhouding <i class="fa-solid fa-piggy-bank"></i></h1>
</header>

<div id="saldoCard">
  <i class="fa-solid fa-wallet"></i>
  <div id="saldo">‚Ç¨ 0,00</div>
</div>

<div id="fixedCostsCard">
  <p>Vaste Kosten</p>
  <div id="fixedCostsList">Geen vaste kosten ingesteld</div>
  <br>
  <button class="btn btn-view" id="fixedCostsBtn">‚öôÔ∏è Instellen</button>
</div>

<div class="actions">
  <button class="btn add" id="addBtn"><i class="fa-solid fa-plus"></i> Toevoegen</button>
  <button class="btn cal" id="calBtn"><i class="fa-solid fa-calendar-days"></i> Kalender</button>
</div>

<div id="calendar"></div>

<!-- MODAL TOEVOEGEN -->
<div id="modal">
  <div class="box">
    <h3>Nieuwe beweging</h3>
    <select id="soort">
      <option value="inkomst">üí∞ Inkomst</option>
      <option value="uitgave">üí∏ Uitgave</option>
    </select>
    <input id="bron" placeholder="Van / Naar">
    <input type="date" id="datum">
    <input type="number" id="bedrag" placeholder="Bedrag">
    <label><input type="checkbox" id="recurring"> Maandelijks</label>
    <br>
    <div style="display:flex;gap:10px;justify-content:flex-end;">
      <button class="btn add" id="saveEntryBtn"><i class="fa-solid fa-floppy-disk"></i> Opslaan</button>
      <button class="btn cancel" id="closeModalBtn"><i class="fa-solid fa-xmark"></i> Annuleren</button>
    </div>
  </div>
</div>

<!-- DAGDETAIL -->
<div id="dayModal">
  <div class="box">
    <h3 id="dayTitle"></h3>
    <div id="dayList"></div>
    <button class="btn cancel" id="closeDayBtn"><i class="fa-solid fa-xmark"></i> Sluiten</button>
  </div>
</div>

<!-- VASTE KOSTEN MODAL -->
<div id="fixedCostsModal">
  <div class="box">
    <h2>Vaste Kosten</h2>
    <input type="number" id="leningInput" placeholder="Lening">
    <input type="number" id="electriciteitInput" placeholder="Electriciteit">
    <input type="number" id="mobiliteitInput" placeholder="Mobiliteit">
    <input type="number" id="verzekeringInput" placeholder="Verzekering">
    <br><br>
    <button class="btn save" id="saveFixedBtn">Opslaan</button>
    <button class="btn cancel" id="closeFixedBtn">Annuleren</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, query } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// ---------------- FIREBASE INIT ----------------
const firebaseConfig = {
  apiKey: "AIzaSyAkBAw17gNU_EBhn8dKgyY5qv-ecfWaG2s",
  authDomain: "finance-jonas.firebaseapp.com",
  projectId: "finance-jonas",
  storageBucket: "finance-jonas.firebasestorage.app",
  messagingSenderId: "497182804753",
  appId: "1:497182804753:web:ea942a578dd1c15f631ab0",
  measurementId: "G-0J29T1Z7MV"
};
const firebaseApp = initializeApp(firebaseConfig);
const auth = getAuth(firebaseApp);
const db = getFirestore(firebaseApp);
window.db = db;
const provider = new GoogleAuthProvider();

// ---------------- AUTH ----------------
const login = async () => {
  try {
    const result = await signInWithPopup(auth, provider);
    window.user = result.user;
    loadData();
  } catch(e) {
    console.error(e);
    alert("Login mislukt!");
  }
};

onAuthStateChanged(auth, (user) => {
  if(!user) login();
  else {
    window.user = user;
    loadData();
  }
});

// ---------------- UI ELEMENTS ----------------
const modal = document.getElementById("modal");
const dayModal = document.getElementById("dayModal");
const fixedCostsModal = document.getElementById("fixedCostsModal");

const soort = document.getElementById("soort");
const bron = document.getElementById("bron");
const datum = document.getElementById("datum");
const bedrag = document.getElementById("bedrag");
const recurring = document.getElementById("recurring");

const dayTitle = document.getElementById("dayTitle");
const dayList = document.getElementById("dayList");

const saldoDiv = document.getElementById("saldo");
const fixedCostsList = document.getElementById("fixedCostsList");

// Inputs fixed costs
const leningInput = document.getElementById("leningInput");
const electriciteitInput = document.getElementById("electriciteitInput");
const mobiliteitInput = document.getElementById("mobiliteitInput");
const verzekeringInput = document.getElementById("verzekeringInput");

// ---------------- MODALS ----------------
function openModal(){ modal.style.display="flex"; }
function closeModal(){ modal.style.display="none"; }
function openDayModal(){ dayModal.style.display="flex"; }
function closeDayModal(){ dayModal.style.display="none"; }
function openFixedCosts(){
  fixedCostsModal.style.display="flex";
  const costs = JSON.parse(localStorage.getItem("fixedCosts"))||{};
  leningInput.value = costs.lening||"";
  electriciteitInput.value = costs.electriciteit||"";
  mobiliteitInput.value = costs.mobiliteit||"";
  verzekeringInput.value = costs.verzekering||"";
}
function closeFixedCosts(){ fixedCostsModal.style.display="none"; }
function saveFixedCosts(){
  const costs = {
    lening: parseFloat(leningInput.value)||0,
    electriciteit: parseFloat(electriciteitInput.value)||0,
    mobiliteit: parseFloat(mobiliteitInput.value)||0,
    verzekering: parseFloat(verzekeringInput.value)||0
  };
  localStorage.setItem("fixedCosts", JSON.stringify(costs));
  closeFixedCosts();
  updateFixedCostsUI();
  loadData();
}
function updateFixedCostsUI(){
  const costs = JSON.parse(localStorage.getItem("fixedCosts"))||{};
  const keys = Object.keys(costs).filter(k=>costs[k]>0);
  if(keys.length===0) fixedCostsList.innerText="Geen vaste kosten ingesteld";
  else fixedCostsList.innerHTML = keys.map(k=>`<span>${k.charAt(0).toUpperCase()+k.slice(1)}: ‚Ç¨ ${costs[k].toFixed(2)}</span>`).join("<br>");
}

// ---------------- SALDO & VERWACHT ----------------
function updateSaldoUI(saldo=0){
  const costs = JSON.parse(localStorage.getItem("fixedCosts"))||{};
  const totalFixed = Object.values(costs).reduce((a,b)=>a+b,0);
  const expectedEnd = saldo - totalFixed;

  saldoDiv.innerHTML = saldo>=0 ? `üí∞ ‚Ç¨ ${saldo.toFixed(2).replace(".",",")}` : `üî¥ ‚Ç¨ ${saldo.toFixed(2).replace(".",",")}`;

  let expectedDiv = document.getElementById("expectedEnd");
  if(!expectedDiv){
    expectedDiv = document.createElement("div");
    expectedDiv.id="expectedEnd";
    expectedDiv.style.textAlign="center";
    expectedDiv.style.marginTop="8px";
    saldoDiv.parentNode.appendChild(expectedDiv);
  }
  expectedDiv.innerHTML = `üîÆ Verwacht einde maand: ‚Ç¨ ${expectedEnd.toFixed(2).replace(".",",")}`;
}

// ---------------- FIRESTORE ----------------
async function saveEntry(){
  const soortVal = soort.value;
  const bronVal = bron.value;
  const datumVal = datum.value;
  const bedragVal = parseFloat(bedrag.value)*(soortVal==="uitgave"?-1:1);
  const recurringVal = recurring.checked;
  if(!datumVal||isNaN(bedragVal)){ alert("Vul alles in"); return; }
  await addDoc(collection(db,"users",user.uid,"items"),{
    soort:soortVal,
    bron:bronVal,
    datum:datumVal,
    bedrag:bedragVal,
    recurring:recurringVal,
    created:Date.now()
  });
  closeModal();
  loadData();
}

async function loadData(){
  const q = query(collection(db,"users",user.uid,"items"));
  const snap = await getDocs(q);

  let saldo=0;
  const now=new Date(), m=now.getMonth(), y=now.getFullYear();
  const items=[];

  snap.forEach(doc=>{
    const e=doc.data();
    saldo += e.bedrag;
    const d=new Date(e.datum);
    items.push({...e,datumObj:d});
  });

  window.items=items;
  updateFixedCostsUI();
  updateSaldoUI(saldo);
}

// ---------------- KALENDER ----------------
function buildCalendar(){
  const calendar = document.getElementById("calendar");
  calendar.innerHTML="";
  const now=new Date();
  const year=now.getFullYear();
  const month=now.getMonth();
  const firstDay=new Date(year,month,1).getDay();
  const daysInMonth=new Date(year,month+1,0).getDate();

  for(let i=0;i<firstDay;i++){
    const empty=document.createElement("div");
    calendar.appendChild(empty);
  }

  for(let d=1;d<=daysInMonth;d++){
    const dayDiv=document.createElement("div");
    dayDiv.className="day";
    dayDiv.innerText=d;

    const dayItems = window.items.filter(item=>{
      const itemDate=item.datumObj;
      return itemDate.getDate()===d && itemDate.getMonth()===month && itemDate.getFullYear()===year;
    });

    if(dayItems.length>0) dayDiv.classList.add("has");

    dayDiv.addEventListener("click", ()=>{
      dayTitle.innerText = `${d}/${month+1}/${year}`;
      dayList.innerHTML = "";
      if(dayItems.length===0) dayList.innerHTML="<p>Geen bewegingen</p>";
      else dayItems.forEach(item=>{
        const p=document.createElement("div");
        p.className="entry "+(item.bedrag>=0?"pos":"neg");
        p.innerText=`${item.soort} - ${item.bron} : ‚Ç¨ ${item.bedrag.toFixed(2).replace(".",",")}`;
        dayList.appendChild(p);
      });
      openDayModal();
    });
    calendar.appendChild(dayDiv);
  }
}

// ---------------- THEME ----------------
function toggleTheme(){ document.body.classList.toggle("dark"); }

// ---------------- EVENT LISTENERS ----------------
document.getElementById("addBtn").addEventListener("click", openModal);
document.getElementById("closeModalBtn").addEventListener("click", closeModal);
document.getElementById("saveEntryBtn").addEventListener("click", saveEntry);
document.getElementById("calBtn").addEventListener("click", buildCalendar);
document.getElementById("fixedCostsBtn").addEventListener("click", openFixedCosts);
document.getElementById("closeFixedBtn").addEventListener("click", closeFixedCosts);
document.getElementById("saveFixedBtn").addEventListener("click", saveFixedCosts);
document.getElementById("themeToggle").addEventListener("click", toggleTheme);
document.getElementById("closeDayBtn").addEventListener("click", closeDayModal);
</script>

</body>
</html>
